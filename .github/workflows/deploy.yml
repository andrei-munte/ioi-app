name: Deploy to WordPress

on:
  push:
    tags:
      - '*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.FTP_SERVER }} >> ~/.ssh/known_hosts
    
    - name: Deploy via rsync over SSH
      env:
        SSH_USER: ${{ secrets.FTP_USERNAME }}
        SSH_HOST: ${{ secrets.FTP_SERVER }}
        SSH_PORT: ${{ secrets.SSH_PORT }}
      run: |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/id_ed25519 -p $SSH_PORT" \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          ./ $SSH_USER@$SSH_HOST:domains/getioi.app/public_html/wp-content/themes/ioi-app/